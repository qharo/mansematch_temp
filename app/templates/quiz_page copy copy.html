{% extends "base.html" %} {% block content %}
<script id="quiz-data-json" type="application/json">
    {{ quiz | tojson | safe }}
</script>

<div class="container mx-auto px-4 py-8 mt-6" id="quiz-container">
    <!-- Loading/Error Message Area -->
    <div id="quiz-message-area" class="text-center py-10">
        <p class="text-xl text-gray-700">Loading quiz...</p>
    </div>

    <!-- Quiz Title (populated by JS) -->
    <h1
        id="quiz-title"
        class="text-3xl font-bold text-gray-800 mb-2"
        style="display: none"
    ></h1>

    <!-- Question Progress (populated by JS) -->
    <p
        id="question-progress"
        class="text-sm text-gray-600 mb-6"
        style="display: none"
    ></p>

    <!-- Form will contain all questions, and we'll show/hide them -->
    <form
        id="quiz-form"
        method="POST"
        action="{{ url_for('submit_quiz_route', quiz_id=quiz.id) }}"
        style="display: none"
    >
        <div id="questions-wrapper">
            <!-- Questions will be injected here by JavaScript -->
        </div>

        <!-- Hidden input for all answers -->
        <input type="hidden" name="answers" id="all-answers-json" />

        <!-- Navigation -->
        <div
            id="quiz-navigation"
            class="flex justify-between items-center mt-8"
            style="display: none"
        >
            <button
                type="button"
                id="prev-question-btn"
                onclick="prevQuestion()"
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-5 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Previous
            </button>
            <button
                type="button"
                id="next-question-btn"
                onclick="nextQuestion()"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-md transition-colors"
            >
                Next
            </button>
            <button
                type="submit"
                id="submit-quiz-btn"
                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-5 rounded-md transition-colors"
                style="display: none"
            >
                Submit Quiz
            </button>
        </div>
    </form>

    <!-- Submitted Message Area (initially hidden) -->
    <div
        id="submitted-message-area"
        class="text-center py-10"
        style="display: none"
    >
        <p class="text-2xl text-green-600 font-semibold">
            Quiz submitted successfully!
        </p>
        <p class="text-gray-600 mt-2">
            You will be redirected to the dashboard shortly.
        </p>
    </div>
</div>

<script>
    let quizData = null;
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = {};

    const quizMessageArea = document.getElementById("quiz-message-area");
    const quizTitleEl = document.getElementById("quiz-title");
    const questionProgressEl = document.getElementById("question-progress");
    const quizFormEl = document.getElementById("quiz-form");
    const questionsWrapperEl = document.getElementById("questions-wrapper");
    const allAnswersJsonInput = document.getElementById("all-answers-json");
    const prevBtn = document.getElementById("prev-question-btn");
    const nextBtn = document.getElementById("next-question-btn");
    const submitBtn = document.getElementById("submit-quiz-btn");
    const quizNavigationEl = document.getElementById("quiz-navigation");

    function escapeHtml(unsafe) {
        if (unsafe === null || typeof unsafe === "undefined") return "";
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function escapeHtmlAttr(unsafe) {
        // Separate function for attribute values to avoid breaking JS syntax
        if (unsafe === null || typeof unsafe === "undefined") return "";
        return String(unsafe).replace(/"/g, "&quot;").replace(/'/g, "&#39;");
    }

    function initializeQuiz() {
        const quizDataScript = document.getElementById("quiz-data-json");

        if (!quizDataScript || !quizDataScript.textContent) {
            quizMessageArea.innerHTML =
                '<p class="text-xl text-red-600">Error: Quiz data script element missing.</p>';
            return;
        }

        try {
            quizData = JSON.parse(quizDataScript.textContent);
        } catch (e) {
            console.error(
                "Failed to parse quiz data:",
                e,
                "Raw content:",
                quizDataScript.textContent,
            );
            quizMessageArea.innerHTML =
                '<p class="text-xl text-red-600">Error: Could not load quiz data (JSON parse failed).</p>';
            return;
        }

        if (!quizData || !quizData.id || !quizData.title) {
            quizMessageArea.innerHTML =
                '<p class="text-xl text-red-600">Error: Invalid quiz data structure.</p>';
            return;
        }

        questions = quizData.questions || [];
        quizTitleEl.textContent = quizData.title;

        if (questions.length === 0) {
            quizTitleEl.style.display = "block";
            quizMessageArea.innerHTML = `
                <p class="text-xl text-gray-700">This quiz currently has no questions.</p>
                <a href="{{ url_for('dashboard_page_route') }}" class="mt-4 inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">
                    Back to Dashboard
                </a>`;
            return;
        }

        userAnswers = {};
        questions.forEach((q) => {
            if (q && q.id) {
                userAnswers[q.id] = null;
            }
        });

        renderQuestions();
        showQuestion(currentQuestionIndex);
        updateNavigation();

        quizMessageArea.style.display = "none";
        quizTitleEl.style.display = "block";
        questionProgressEl.style.display = "block";
        quizFormEl.style.display = "block";
        quizNavigationEl.style.display = "flex";
    }

    function renderQuestions() {
        questionsWrapperEl.innerHTML = "";
        questions.forEach((question) => {
            if (!question || !question.id) {
                console.warn(
                    "Skipping invalid question during render (missing id):",
                    question,
                );
                return;
            }
            const questionDiv = document.createElement("div");
            questionDiv.id = `question-${question.id}`;
            questionDiv.className =
                "bg-white p-6 rounded-xl shadow-lg mb-8 question-item";
            questionDiv.style.display = "none";

            let optionsHtml = "";
            const qidStr = String(question.id);

            if (
                question.type === "multiple-choice" &&
                Array.isArray(question.options_map)
            ) {
                optionsHtml = question.options_map
                    .map((opt) => {
                        const escapedOptionDisplay = escapeHtml(opt.text);
                        const escapedOptionValue = escapeHtmlAttr(
                            String(opt.value),
                        );
                        return `
                    <div>
                        <label class="flex items-center p-3 rounded-md hover:bg-gray-100 cursor-pointer transition-colors">
                            <input type="radio" name="q_${qidStr}" value="${escapedOptionValue}"
                                   class="form-radio h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300"
                                   onchange="updateAnswer('${qidStr}', this.value)">
                            <span class="ml-3 text-gray-700">${escapedOptionDisplay}</span>
                        </label>
                    </div>`;
                    })
                    .join("");
            } else if (
                question.type === "multiple-choice" &&
                Array.isArray(question.options)
            ) {
                optionsHtml = question.options
                    .map((optionText) => {
                        const escapedOptionDisplay = escapeHtml(optionText);
                        const escapedOptionValue = escapeHtmlAttr(optionText);
                        return `
                    <div>
                        <label class="flex items-center p-3 rounded-md hover:bg-gray-100 cursor-pointer transition-colors">
                            <input type="radio" name="q_${qidStr}" value="${escapedOptionValue}"
                                   class="form-radio h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300"
                                   onchange="updateAnswer('${qidStr}', this.value)">
                            <span class="ml-3 text-gray-700">${escapedOptionDisplay}</span>
                        </label>
                    </div>`;
                    })
                    .join("");
            }

            const questionTextHtml = escapeHtml(question.text);
            questionDiv.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-700 mb-4">I see myself as someone who... <br><strong>${questionTextHtml}</strong></h2>
                <div class="space-y-3">${optionsHtml}</div>
            `;
            try {
                questionsWrapperEl.appendChild(questionDiv);
            } catch (e) {
                console.error(
                    "Error appending question div:",
                    e,
                    "Question ID:",
                    question.id,
                    "HTML:",
                    questionDiv.innerHTML,
                );
            }
        });
    }

    function showQuestion(index) {
        document
            .querySelectorAll(".question-item")
            .forEach((el) => (el.style.display = "none"));
        if (questions[index] && questions[index].id) {
            const currentQuestionEl = document.getElementById(
                `question-${questions[index].id}`,
            );
            if (currentQuestionEl) {
                currentQuestionEl.style.display = "block";
                const qId = questions[index].id;
                if (
                    userAnswers[qId] !== null &&
                    typeof userAnswers[qId] !== "undefined"
                ) {
                    const selectedRadio = currentQuestionEl.querySelector(
                        `input[name="q_${qId}"][value="${escapeHtmlAttr(String(userAnswers[qId]))}"]`,
                    );
                    if (selectedRadio) {
                        selectedRadio.checked = true;
                    }
                }
            }
        }
        questionProgressEl.textContent = `Question ${index + 1} of ${questions.length}`;
    }

    window.updateAnswer = function (questionId, answerValue) {
        try {
            const numValue = parseFloat(answerValue);
            if (!isNaN(numValue) && String(numValue) === String(answerValue)) {
                userAnswers[questionId] = numValue;
            } else {
                userAnswers[questionId] = String(answerValue);
            }
        } catch (e) {
            userAnswers[questionId] = String(answerValue);
        }
    };

    // --- ADDED FUNCTIONS ---
    function nextQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
            updateNavigation();
        }
    }

    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showQuestion(currentQuestionIndex);
            updateNavigation();
        }
    }
    // --- END ADDED FUNCTIONS ---

    function updateNavigation() {
        prevBtn.disabled = currentQuestionIndex === 0;
        if (currentQuestionIndex === questions.length - 1) {
            nextBtn.style.display = "none";
            submitBtn.style.display = "inline-block";
        } else {
            nextBtn.style.display = "inline-block";
            submitBtn.style.display = "none";
        }
    }

    quizFormEl.addEventListener("submit", function (event) {
        if (quizData && quizData.id === "bfi-10") {
            let allAnswered = true;
            for (const q of questions) {
                if (
                    userAnswers[q.id] === null ||
                    typeof userAnswers[q.id] === "undefined"
                ) {
                    allAnswered = false;
                    break;
                }
            }
            if (!allAnswered) {
                event.preventDefault();
                alert("Please answer all 10 questions before submitting.");
                return;
            }
        }
        allAnswersJsonInput.value = JSON.stringify(userAnswers);
    });

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeQuiz);
    } else {
        if (
            document.getElementById("quiz-container") &&
            document.getElementById("quiz-data-json")
        ) {
            initializeQuiz();
        } else {
            document.addEventListener("DOMContentLoaded", initializeQuiz);
        }
    }
</script>
{% endblock %} {% block scripts %} {# Scripts specific to quiz_page are now in
the content block above #} {% endblock %}
